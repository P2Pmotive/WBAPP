sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/m/library","sap/m/MessageToast"],function(e,t,i,a,o){"use strict";var r=a.URLHelper;return e.extend("wbui.controller.Detail",{formatter:i,onInit:function(){var e=new t({busy:false,delay:0,lineItemListTitle:this.getResourceBundle().getText("detailLineItemTableHeading")});this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.setModel(e,"detailView");this.oDataModel=this.getOwnerComponent().getModel();this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this));var i=new t;this.setModel(i,"oDataGrossWeightModel");var a=new t;a.setDefaultBindingMode("TwoWay");this.getView().setModel(a,"detailModel");var o=new Date;var r=o.getDate();var s=o.getMonth()+1;var n=o.getFullYear();var l=o.getHours();var d=o.getMinutes();var g=o.getSeconds();var u=r+"."+s+"."+n+" "+l+":"+d+":"+g},onSendEmailPress:function(){var e=this.getModel("detailView");r.triggerEmail(null,e.getProperty("/shareSendEmailSubject"),e.getProperty("/shareSendEmailMessage"))},handleSaveWeight:function(e){var t=this.getOwnerComponent().getModel();var i=this.getView();var a=this;function r(){console.log("Successfully saved Weight Details");a._updateCloudTable(n.urlParameters);o.show("Successfully saved Weight Details")}function s(){a._updateCloudTable(n.urlParameters,"X");console.log("Failed to sent to backend")}var n={method:"POST",urlParameters:{PurchaseOrder:i.byId("semPageTitle").getText(),VehicalNo:i.byId("idVehicle").getValue(),GrossWeight:i.byId("idGW").getText().replace(/[^\d\.\-]/g,""),TareWeight:i.byId("idTW").getText().replace(/[^\d\.\-]/g,""),UnitOfMeasure:i.byId("idU").getText()},context:null,success:r,error:s,async:true};t.callFunction("/Zcustompo",n)},_updateCloudTable:function(e,t){var i=this.getView();var a=this.getOwnerComponent().getModel("hanaModel");var o={PoNo:e.PurchaseOrder,vehical_No:e.VehicalNo,error_status:t===undefined?"":t,Gross_weight:e.GrossWeight,Tare_weight:e.TareWeight,Net_weight:i.byId("idNW").getText().replace(/[^\d\.\-]/g,""),Uom:e.UnitOfMeasure};a.create("/offSyncWeightDetails",o,null,function(){console.log("successfully updated the cloud table")},function(){console.log("Failed to update the cloud table")})},handleTareWt:function(e){var t;var i=this.getOwnerComponent().getModel("hanaModel");var a=new sap.ui.model.Filter({path:"gate",operator:sap.ui.model.FilterOperator.EQ,value1:"OUT"});i.read("/GTWeightDetails",{filters:[a],success:function(e,t){var i=e.results;var a=i[0].weight;var o=this.formatter.onFormatNumber(a);this.getView().byId("idTW").setText(o);this.calculateNetWeight();this.getView().getModel("detailModel").refresh()}.bind(this),error:jQuery.proxy(function(e){alert("Try Again")})})},handleGrossWt:function(e){var t;var i=this.getOwnerComponent().getModel("hanaModel");var a=new sap.ui.model.Filter({path:"gate",operator:sap.ui.model.FilterOperator.EQ,value1:"IN"});i.read("/GTWeightDetails",{filters:[a],success:function(e,t){var i=e.results;var a=i[0].weight;var o=this.formatter.onFormatNumber(a);this.getView().byId("idGW").setText(o);var r=i[0].uom;this.getView().byId("idU").setText(r);this.calculateNetWeight();this.getView().getModel("detailModel").refresh()}.bind(this),error:jQuery.proxy(function(e){alert("Try Again")})})},calculateNetWeight:function(e){var t=parseFloat(this.getView().byId("idGW").getText().replace(/[^\d\.\-]/g,""));var i=parseFloat(this.getView().byId("idTW").getText().replace(/[^\d\.\-]/g,""));if(t>0&&i>0){var a=Math.abs(t-i);var o=this.formatter.onFormatNumber(a);this.getView().byId("idNW").setText(o);this.getView().byId("idWD").setEnabled(true)}},onListUpdateFinished:function(e){var t,i=e.getParameter("total"),a=this.getModel("detailView");if(this.byId("lineItemsList").getBinding("items").isLengthFinal()){if(i){t=this.getResourceBundle().getText("detailLineItemTableHeadingCount",[i])}else{t=this.getResourceBundle().getText("detailLineItemTableHeading")}a.setProperty("/lineItemListTitle",t)}},_onObjectMatched:function(e){var t=e.getParameter("arguments").objectId;t=t.replace(":","%3A");var i="/POHeaders('"+t+"')";this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");this.getModel().metadataLoaded().then(function(){this.oDataModel.read(i,{urlParameters:{$expand:["Items"]},success:function(e,t){var i=e.Items.results;this.getView().getModel("detailModel").setData(e);this.getView().getModel("detailView").setProperty("/busy",false)}.bind(this),error:function(e,t,i){this.getView().getModel("detailView").setProperty("/busy",false)}.bind(this)})}.bind(this))},_bindView:function(e){var t=this.getModel("detailView");t.setProperty("/busy",false);this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){t.setProperty("/busy",true)},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("detailObjectNotFound");this.getOwnerComponent().oListSelector.clearListListSelection();return}var i=t.getPath(),a=this.getResourceBundle(),o=e.getModel().getObject(i),r=o.Id,s=o.PurchaseOrder,n=this.getModel("detailView");this.getOwnerComponent().oListSelector.selectAListItem(i);n.setProperty("/shareSendEmailSubject",a.getText("shareSendEmailObjectSubject",[r]));n.setProperty("/shareSendEmailMessage",a.getText("shareSendEmailObjectMessage",[s,r,location.href]))},_onMetadataLoaded:function(){var e=this.getView().getBusyIndicatorDelay(),t=this.getModel("detailView"),i=this.byId("lineItemsList"),a=i.getBusyIndicatorDelay();t.setProperty("/delay",0);t.setProperty("/lineItemTableDelay",0);i.attachEventOnce("updateFinished",function(){t.setProperty("/lineItemTableDelay",a)});t.setProperty("/busy",true);t.setProperty("/delay",e)},onCloseDetailPress:function(){this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",false);this.getOwnerComponent().oListSelector.clearListListSelection();this.getRouter().navTo("list")},toggleFullScreen:function(){var e=this.getModel("appView").getProperty("/actionButtonsInfo/midColumn/fullScreen");this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",!e);if(!e){this.getModel("appView").setProperty("/previousLayout",this.getModel("appView").getProperty("/layout"));this.getModel("appView").setProperty("/layout","MidColumnFullScreen")}else{this.getModel("appView").setProperty("/layout",this.getModel("appView").getProperty("/previousLayout"))}}})});